<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="style.css" />
    <title>Voice Input PWA</title>
  </head>
  <body>
    <h1>V 6</h1>
    <button id="mic-button">Press to speak</button>
  </body>
  <script>
      const micButton = document.getElementById('mic-button');
      micButton.addEventListener('click', startVoiceRecognition);
      var conversation = [];
      const queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);
      const API_KEY = urlParams.get('API_KEY')
      function startVoiceRecognition() {
            const recognition = new webkitSpeechRecognition();
            recognition.onresult = async function (event) {
                const transcript = event.results[0][0].transcript;
                const input = document.createElement('p');
                input.textContent = transcript;
                document.body.appendChild(input);
                let history = "";
                if (conversation.len > 0) {
                   console.log("there is a history:");
                   history += "Our conversation so far:\n\n"
                   conversation.forEach(item => {
                    history += `I said: "${item.input}"\n\n`;
                    history += `You responded: "${item.output}"\n\n\n`;
                  });
                  console.log(history);
                } else {
                  console.log("conversation is empty");
                }
                history += `I say: "${transcript}"\n\n`;
                history += `You respond:`;
                console.log(history);
                const completedText = await completeText(history);   
                const output = document.createElement('p');
                output.textContent = completedText;
                document.body.appendChild(output);
                let turn = {
                    input: transcript,
                    output: completedText
                }
                conversation.push(turn);
                console.log(turn);
                // Synthesize speech from the text
                const synth = window.speechSynthesis;
                const speakText = new SpeechSynthesisUtterance(completedText);

                // Get a list of available voices
                const voices = synth.getVoices();
                // Set the voice to the first available female voice
                speakText.voice = voices.find(voice => voice.gender === 'female');

                speakText.rate = 0.9;
              
                synth.speak(speakText);
            };
            recognition.start();
      }
       async function completeText(text) {
          
          var url = "https://api.openai.com/v1/completions";
          var bearer = 'Bearer ' + API_KEY
          const response = await fetch(url, {
            method: 'POST',
            headers: {
              'Authorization': bearer,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              "prompt": text,
              "model": "text-davinci-003",
              "max_tokens": 1024
            })


          })
            .catch(error => {
              console.log('Something bad happened ' + error)
            });
        data = await response.json();
        console.log("Answer: " + data['choices'][0].text);
        return data['choices'][0].text;
         
      }

  </script>
</html>
